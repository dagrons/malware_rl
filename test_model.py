import argparse
import os
from malware_rl.envs.utils import malconv, ember, sorel, interface
from malware_rl.envs.utils.model import Model
import random
from tqdm import tqdm
import sys


model_cls = {
    "malconv": malconv.MalConv,
    "ember": ember.EmberModel,
    "sorel": sorel.SorelModel
}


def test(model_name, model_args, test_args={}):
    # compute acc of model
    sha256list = interface.get_available_sha256()
    model: Model = model_cls[model_name](**model_args)
    count = 0
    for i in tqdm(range(test_args["episode_count"])):
        # sample from sha256list
        ob = interface.fetch_file(os.path.join(
            interface.SAMPLE_PATH, random.choice(sha256list)))
        if model.detect(ob):
            count += 1
    acc = count / test_args["episode_count"]
    print(f"acc: {acc*100}%.")


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--model", type=str,
                        required=True)
    args = parser.parse_args()

    test_args = {
        "episode_count": 100
    }

    test(model_name=args.model, model_args={}, test_args=test_args)


if __name__ == "__main__":
    main()
